name: Vendor packages

on:
  schedule:    
  - cron: "2 8,13 * * *"
  repository_dispatch:
    types:
      - "promote-to-prod" 

jobs:
  pipeline:
    runs-on:
      - linux
    steps:
      - name: Triggered by event
        if: github.event_name == 'repository_dispatch'
        run: 'echo "Triggered by: ${{ github.event.client_payload.user }}"'

      - name: Cleanup files
        if: ${{ always() }}
        run: 'sudo rm -r * || true'

      - name: Checkout Repository
        uses: actions/checkout@v2
        with:
          token: ${{ secrets.GH_REPO_PAT_TOKEN }}

      - name: Promote manifests
        with:
          entrypoint: '.github/scripts/copy-files.sh'
          args: 'nonprod-cluster/* prod-cluster'
        uses: docker://benjvi/prify:latest

      - name: Make PRs
        with:
          entrypoint: '.github/scripts/run-prify.sh'
          args: 'nonprod-cluster'
        uses: docker://benjvi/prify:latest

      - name: Cleanup files
        if: ${{ always() }}
        run: 'sudo rm -r * || true'


